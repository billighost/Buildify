{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- Sidebar Navigation -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Account Settings</h5>
                </div>
                <!-- In the sidebar navigation, add a notifications link -->
                <div class="list-group list-group-flush">
                    <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="tab">
                        <i class="bi bi-person me-2"></i>Profile
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-bell me-2"></i>Notifications
                        {% if current_user.get_notification_count() > 0 %}
                        <span class="badge bg-primary float-end">{{ current_user.get_notification_count() }}</span>
                        {% endif %}
                    </a>
                    <a href="#preferences" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-gear me-2"></i>Preferences
                    </a>
                    <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-shield-lock me-2"></i>Security
                    </a>
                    <a href="#stats" class="list-group-item list-group-item-action" data-bs-toggle="tab">
                        <i class="bi bi-graph-up me-2"></i>Statistics
                    </a>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="profile-picture-large mb-3">
                        <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" 
                             class="rounded-circle" alt="Profile Picture" width="80" height="80">
                    </div>
                    <h6>{{ current_user.first_name }} {{ current_user.last_name }}</h6>
                    <p class="text-muted small">@{{ current_user.username }}</p>
                    <div class="row g-2 text-center">
                        <div class="col-6">
                            <div class="stat">
                                <div class="stat-value text-primary">{{ user_stats.total_projects }}</div>
                                <div class="stat-label">Projects</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat">
                                <div class="stat-value text-success">{{ user_stats.total_blocks }}</div>
                                <div class="stat-label">Blocks</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- Profile Tab -->
                <div class="tab-pane fade show active" id="profile">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Profile Information</h5>
                            <span class="badge bg-success">Member since {{ user_stats.member_since }}</span>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <div class="profile-picture-section mb-4">
                                        <img src="{{ url_for('static', filename='profile_pics/' + current_user.profile_pic) }}" 
                                             class="rounded-circle shadow profile-picture-main" 
                                             alt="Profile Picture" width="150" height="150">
                                        <div class="mt-3">
                                            <form method="POST" action="{{ url_for('auth.update_profile_picture') }}" 
                                                  enctype="multipart/form-data" class="d-inline">
                                                {{ picture_form.hidden_tag() }}
                                                <div class="mb-2">
                                                    {{ picture_form.picture(class="form-control form-control-sm", 
                                                        onchange="this.form.submit()") }}
                                                </div>
                                            </form>
                                            {% if current_user.profile_pic != 'default.jpg' %}
                                            <form method="POST" action="{{ url_for('auth.remove_profile_picture') }}" class="d-inline">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                        onclick="return confirm('Remove profile picture?')">
                                                    Remove Picture
                                                </button>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <form method="POST" action="{{ url_for('auth.account') }}">
                                        {{ profile_form.hidden_tag() }}
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.first_name.label(class="form-label") }}
                                                    {{ profile_form.first_name(class="form-control") }}
                                                    {% for error in profile_form.first_name.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.last_name.label(class="form-label") }}
                                                    {{ profile_form.last_name(class="form-control") }}
                                                    {% for error in profile_form.last_name.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.username.label(class="form-label") }}
                                                    {{ profile_form.username(class="form-control") }}
                                                    {% for error in profile_form.username.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.email.label(class="form-label") }}
                                                    {{ profile_form.email(class="form-control") }}
                                                    {% for error in profile_form.email.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.phone.label(class="form-label") }}
                                                    {{ profile_form.phone(class="form-control", placeholder="+234 800 000 0000") }}
                                                    {% for error in profile_form.phone.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.location.label(class="form-label") }}
                                                    {{ profile_form.location(class="form-select") }}
                                                    {% for error in profile_form.location.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.company.label(class="form-label") }}
                                                    {{ profile_form.company(class="form-control", placeholder="Your company name") }}
                                                    {% for error in profile_form.company.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    {{ profile_form.occupation.label(class="form-label") }}
                                                    {{ profile_form.occupation(class="form-select") }}
                                                    {% for error in profile_form.occupation.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-group">
                                                    {{ profile_form.bio.label(class="form-label") }}
                                                    {{ profile_form.bio(class="form-control", rows="4", 
                                                                        placeholder="Tell us about yourself...") }}
                                                    {% for error in profile_form.bio.errors %}
                                                    <div class="text-danger small">{{ error }}</div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="col-12">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        Last updated: {{ current_user.updated_at.strftime('%b %d, %Y at %H:%M') }}
                                                    </small>
                                                    {{ profile_form.submit(class="btn btn-primary") }}
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Notifications Tab -->
                <div class="tab-pane fade" id="notifications">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-bell me-2"></i>Notifications
                                {% if current_user.get_notification_count() > 0 %}
                                <span class="badge bg-primary ms-2">{{ current_user.get_notification_count() }} unread</span>
                                {% endif %}
                            </h5>
                            <div>
                                <a href="{{ url_for('auth.notifications') }}" class="btn btn-outline-primary btn-sm me-2">
                                    View All
                                </a>
                                {% if current_user.get_notification_count() > 0 %}
                                <button class="btn btn-primary btn-sm" onclick="markAllNotificationsRead()">
                                    Mark All Read
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="account-notifications">
                                <!-- Notifications will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences Tab -->
                <div class="tab-pane fade" id="preferences">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Application Preferences</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="{{ url_for('auth.account_preferences') }}">
                                {{ profile_form.hidden_tag() }}
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Default Block Type</label>
                                            <select class="form-select" name="preferred_block_type">
                                                <option value="9_inch_hollow" {% if current_user.preferred_block_type == '9_inch_hollow' %}selected{% endif %}>
                                                    9-inch Hollow Block
                                                </option>
                                                <option value="6_inch_hollow" {% if current_user.preferred_block_type == '6_inch_hollow' %}selected{% endif %}>
                                                    6-inch Hollow Block
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Waste Percentage</label>
                                            <select class="form-select" name="preferred_waste_percentage">
                                                <option value="5" {% if current_user.preferred_waste_percentage == 5 %}selected{% endif %}>5% (Very Efficient)</option>
                                                <option value="10" {% if current_user.preferred_waste_percentage == 10 %}selected{% endif %}>10% (Standard)</option>
                                                <option value="15" {% if current_user.preferred_waste_percentage == 15 %}selected{% endif %}>15% (Conservative)</option>
                                                <option value="20" {% if current_user.preferred_waste_percentage == 20 %}selected{% endif %}>20% (High Waste)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Measurement System</label>
                                            <select class="form-select" name="measurement_system">
                                                <option value="feet" {% if current_user.measurement_system == 'feet' %}selected{% endif %}>Feet and Inches</option>
                                                <option value="meters" {% if current_user.measurement_system == 'meters' %}selected{% endif %}>Meters</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Preferred Currency</label>
                                            <select class="form-select" name="preferred_currency">
                                                <option value="₦" {% if current_user.preferred_currency == '₦' %}selected{% endif %}>Naira (₦)</option>
                                                <option value="$" {% if current_user.preferred_currency == '$' %}selected{% endif %}>US Dollar ($)</option>
                                                <option value="€" {% if current_user.preferred_currency == '€' %}selected{% endif %}>Euro (€)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-group">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="email_notifications" 
                                                       {% if current_user.email_notifications %}checked{% endif %}>
                                                <label class="form-check-label">Email Notifications</label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="sms_notifications"
                                                       {% if current_user | attr('sms_notifications') %}checked{% endif %}
                                                <label class="form-check-label">SMS Notifications</label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="marketing_emails"
                                                       {% if current_user | attr('marketing_emails') %}checked{% endif %}
                                                <label class="form-check-label">Marketing Emails</label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Security Tab -->
                <div class="tab-pane fade" id="security">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Change Password</h5>
                                </div>
                                <div class="card-body">
                                    <form method="POST" action="{{ url_for('auth.change_password') }}">
                                        {{ profile_form.hidden_tag() }}
                                        <div class="form-group mb-3">
                                            <label class="form-label">Current Password</label>
                                            <input type="password" class="form-control" name="current_password" required>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label class="form-label">New Password</label>
                                            <input type="password" class="form-control" name="new_password" required>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" name="confirm_password" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Change Password</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0 text-danger">Danger Zone</h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-warning">
                                        <h6 class="alert-heading">Delete Account</h6>
                                        <p class="mb-2">Once you delete your account, there is no going back. Please be certain.</p>
                                        <a href="{{ url_for('auth.delete_account') }}" class="btn btn-outline-danger btn-sm">
                                            Delete My Account
                                        </a>
                                    </div>
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">Export Data</h6>
                                        <p class="mb-2">Download all your data in a portable format.</p>
                                        <button class="btn btn-outline-info btn-sm" onclick="exportUserData()">
                                            Export My Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Statistics Tab -->
                <div class="tab-pane fade" id="stats">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Your Buildify Statistics</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <div class="col-md-3 col-6">
                                    <div class="stat-card text-center">
                                        <div class="stat-icon bg-primary text-white">
                                            <i class="bi bi-folder"></i>
                                        </div>
                                        <h3 class="stat-value mt-3">{{ user_stats.total_projects }}</h3>
                                        <p class="stat-label">Total Projects</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card text-center">
                                        <div class="stat-icon bg-success text-white">
                                            <i class="bi bi-cube"></i>
                                        </div>
                                        <h3 class="stat-value mt-3">{{ user_stats.total_blocks }}</h3>
                                        <p class="stat-label">Blocks Calculated</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card text-center">
                                        <div class="stat-icon bg-info text-white">
                                            <i class="bi bi-house"></i>
                                        </div>
                                        <h3 class="stat-value mt-3">{{ user_stats.favorite_house_type }}</h3>
                                        <p class="stat-label">Favorite House Type</p>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="stat-card text-center">
                                        <div class="stat-icon bg-warning text-white">
                                            <i class="bi bi-calendar"></i>
                                        </div>
                                        <h3 class="stat-value mt-3">{{ user_stats.member_since }}</h3>
                                        <p class="stat-label">Member Since</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity -->
                            <div class="mt-5">
                                <h6>Recent Activity</h6>
                                <div class="list-group list-group-flush">
                                    {% if recent_projects %}
                                        {% for project in recent_projects %}
                                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>{{ project.title }}</strong>
                                                    <small class="text-muted d-block">
                                                        {{ project.house_type.replace('_', ' ').title() }}
                                                    </small>
                                                </div>
                                                <div class="text-end">
                                                    <small class="text-muted">{{ project.updated_at.strftime('%b %d') }}</small>
                                                    <div class="text-primary">{{ project.total_blocks or 0 }} blocks</div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="list-group-item text-center text-muted py-4">
                                            <i class="bi bi-inbox display-4 d-block mb-2"></i>
                                            No projects yet. <a href="{{ url_for('projects.new_project') }}">Create your first project</a>
                                        </div>
                                    {% endif %}

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    // Activate tabs based on URL hash
    const urlHash = window.location.hash;
    if (urlHash) {
        const tabTrigger = document.querySelector(`[href="${urlHash}"]`);
        if (tabTrigger) {
            new bootstrap.Tab(tabTrigger).show();
        }
    }
    const notificationsTab = document.querySelector('a[href="#notifications"]');
    if (notificationsTab) {
        notificationsTab.addEventListener('shown.bs.tab', function() {
            loadAccountNotifications();
        });
    }

    // Update URL when tabs are clicked
    const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
    tabLinks.forEach(link => {
        link.addEventListener('shown.bs.tab', function (e) {
            window.location.hash = e.target.getAttribute('href');
        });
    });

    // Profile picture preview
    const profilePictureInput = document.querySelector('input[name="picture"]');
    if (profilePictureInput) {
        profilePictureInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.querySelector('.profile-picture-main').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }
});

function exportUserData() {
    // Implement data export functionality
    alert('Data export feature coming soon!');
    // This would typically make an API call to export user data
}
// Load notifications for account page
function loadAccountNotifications() {
    fetch('/api/notifications?limit=10&unread_only=false')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('account-notifications');
                if (data.notifications.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-5 text-muted">
                            <i class="bi bi-bell-slash display-4 d-block mb-3"></i>
                            <h5>No notifications</h5>
                            <p>You're all caught up! New notifications will appear here.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.notifications.map(notification => `
                        <div class="notification-item card mb-2 ${notification.is_read ? '' : 'border-primary'}">
                            <div class="card-body py-2">
                                <div class="d-flex align-items-start">
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 ${notification.is_read ? '' : 'text-primary'}">
                                            ${notification.title}
                                        </h6>
                                        <p class="mb-1 small">${notification.message}</p>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>${notification.time_ago}
                                        </small>
                                    </div>
                                    <div class="ms-3">
                                        ${!notification.is_read ? '<span class="badge bg-primary">New</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            document.getElementById('account-notifications').innerHTML = `
                <div class="alert alert-danger">Error loading notifications</div>
            `;
        });
}
</script>
{% endblock %}