{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('teams.teams_dashboard') }}">Teams</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('teams.team_detail', team_id=team.id) }}">{{ team.name }}</a></li>
                    <li class="breadcrumb-item active">Settings</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Team Settings</h1>
                <a href="{{ url_for('teams.team_detail', team_id=team.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Team
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column - Team Configuration -->
        <div class="col-lg-6">
            <!-- Basic Information -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Basic Information</h5>
                </div>
                <div class="card-body">
                    <form id="teamSettingsForm">
                        <div class="mb-3">
                            <label class="form-label">Team Name</label>
                            <input type="text" class="form-control" id="teamName" value="{{ team.name }}" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="teamDescription" rows="3">{{ team.description or '' }}</textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Team Color</label>
                            <div class="input-group">
                                <input type="color" class="form-control form-control-color" id="teamColor" value="{{ team.team_color }}" title="Choose team color">
                                <span class="input-group-text">{{ team.team_color }}</span>
                            </div>
                            <div class="form-text">This color will be used for team branding</div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="updateTeamSettings({{ team.id }})">
                            <i class="bi bi-check-lg me-1"></i>Save Changes
                        </button>
                    </form>
                </div>
            </div>

            <!-- Team Permissions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Team Permissions</h5>
                </div>
                <div class="card-body">
                    <form id="teamPermissionsForm">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="allowMemberInvites" 
                                   {% if team.allow_member_invites %}checked{% endif %}>
                            <label class="form-check-label" for="allowMemberInvites">
                                <strong>Allow Members to Invite Others</strong>
                                <div class="form-text">Regular members can invite new users to the team</div>
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Default Project Privacy</label>
                            <select class="form-select" id="defaultProjectPrivacy">
                                <option value="private" {% if team.default_project_privacy == 'private' %}selected{% endif %}>Private (Only project creator)</option>
                                <option value="team" {% if team.default_project_privacy == 'team' %}selected{% endif %}>Team (All team members)</option>
                                <option value="public" {% if team.default_project_privacy == 'public' %}selected{% endif %}>Public (Anyone with link)</option>
                            </select>
                            <div class="form-text">Default privacy setting for new projects created in this team</div>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="allowProjectDeletion" 
                                   {% if team.allow_project_deletion %}checked{% endif %}>
                            <label class="form-check-label" for="allowProjectDeletion">
                                <strong>Allow Members to Delete Projects</strong>
                                <div class="form-text">Regular members can delete projects they created</div>
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary" onclick="updateTeamPermissions({{ team.id }})">
                            Update Permissions
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Column - Members & Statistics -->
        <div class="col-lg-6">
            <!-- Team Members Management -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Team Members</h5>
                    <span class="badge bg-primary">{{ team_stats.total_members }}</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Role</th>
                                    <th>Projects</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for member in members %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3">
                                                {{ member.user.first_name[0] }}{{ member.user.last_name[0] }}
                                            </div>
                                            <div>
                                                <strong>{{ member.user.first_name }} {{ member.user.last_name }}</strong>
                                                <br>
                                                <small class="text-muted">@{{ member.user.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <select class="form-select form-select-sm member-role" 
                                                data-member-id="{{ member.id }}"
                                                {% if member.user_id == current_user.id and member.role == 'owner' and team_stats.member_roles.owner <= 1 %}disabled{% endif %}
                                                {% if user_membership.role not in ['owner', 'admin'] %}disabled{% endif %}>
                                            <option value="owner" {% if member.role == 'owner' %}selected{% endif %}>Owner</option>
                                            <option value="admin" {% if member.role == 'admin' %}selected{% endif %}>Admin</option>
                                            <option value="member" {% if member.role == 'member' %}selected{% endif %}>Member</option>
                                        </select>
                                    </td>
                                    <td>
                                        {% set user_projects = team.projects.filter_by(user_id=member.user_id).count() %}
                                        <span class="badge bg-secondary">{{ user_projects }}</span>
                                    </td>
                                    <td>
                                        {% if member.user_id != current_user.id and user_membership.role in ['owner', 'admin'] %}
                                        <button class="btn btn-outline-danger btn-sm" 
                                                onclick="removeTeamMember({{ team.id }}, {{ member.user.id }})"
                                                title="Remove from team">
                                            <i class="bi bi-person-x"></i>
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-grid mt-3">
                        {% if team_roles[team.id] %}
                            <button class="btn btn-outline-secondary btn-sm" onclick="inviteToTeam({{ team.id }})">
                                <i class="bi bi-person-plus"></i> Invite Members
                            </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Team Statistics -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Team Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-4">
                        <div class="col-4">
                            <div class="stat">
                                <div class="stat-value text-primary">{{ team_stats.total_members }}</div>
                                <div class="stat-label">Members</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat">
                                <div class="stat-value text-success">{{ team_stats.total_projects }}</div>
                                <div class="stat-label">Projects</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat">
                                <div class="stat-value text-info">{{ team_stats.total_blocks|number_format }}</div>
                                <div class="stat-label">Blocks</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Member Roles</h6>
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Owners:</span>
                            <strong>{{ team_stats.member_roles.owner }}</strong>
                        </div>
                        <div class="d-flex justify-content-between small mb-1">
                            <span>Admins:</span>
                            <strong>{{ team_stats.member_roles.admin }}</strong>
                        </div>
                        <div class="d-flex justify-content-between small">
                            <span>Members:</span>
                            <strong>{{ team_stats.member_roles.member }}</strong>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Active Members</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: {{ (team_stats.active_members / team_stats.total_members * 100) if team_stats.total_members > 0 else 0 }}%">
                                {{ team_stats.active_members }}/{{ team_stats.total_members }}
                            </div>
                        </div>
                        <small class="text-muted">Active in last 30 days</small>
                    </div>
                    
                    <hr>
                    
                    <div class="team-meta">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Team Created:</span>
                            <strong>{{ team.created_at.strftime('%b %d, %Y') }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="text-muted">Last Updated:</span>
                            <strong>{{ team.updated_at.strftime('%b %d, %Y') }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            {% if user_membership.role == 'owner' %}
            <div class="card border-0 shadow-sm border-danger mt-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">Danger Zone</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        Once you delete a team, there is no going back. Please be certain.
                    </p>
                    <button class="btn btn-outline-danger" onclick="deleteTeam({{ team.id }})">
                        <i class="bi bi-trash me-1"></i>Delete This Team
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Invite to Team Modal -->
<div class="modal fade" id="inviteToTeamModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invite to Team</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Search Users</label>
                    <input type="text" class="form-control" id="userSearch" placeholder="Type username...">
                    <div id="userSearchResults" class="mt-2"></div>
                </div>
                <div id="selectedUsers" class="mb-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendTeamInvitations()">Send Invitations</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTeamId = null;
let selectedUsers = [];

// User search and selection
// Utility functions
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function setupUserSearch() {
    const userSearch = document.getElementById('userSearch');
    if (!userSearch) return;

    userSearch.addEventListener('input', debounce((e) => {
        const query = e.target.value;
        if (query.length < 2) {
            document.getElementById('userSearchResults').innerHTML = '';
            return;
        }

        fetch(`/teams/users/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('userSearchResults');
                    container.innerHTML = data.users.map(user => `
                        <div class="search-result-item p-2 border rounded mb-1 cursor-pointer" 
                             onclick="selectUser(0, ${JSON.stringify(user).replace(/"/g, '&quot;')})">
                            <div class="fw-bold">${user.username}</div>
                            <small class="text-muted">${user.first_name} ${user.last_name}</small>
                        </div>
                    `).join('');
                }
            });
    }, 300));
}


function selectUser(type, user) {
    const targetArray = type === 0 ? selectedUsers : projectSelectedUsers;
    const targetContainer = type === 0 ? 'selectedUsers' : 'projectSelectedUsers';
    
    if (!targetArray.find(u => u.id === user.id)) {
        targetArray.push(user);
        updateSelectedUsers(type);
    }
    
    // Clear search
    document.getElementById(type === 0 ? 'userSearch' : 'projectUserSearch').value = '';
    document.getElementById(type === 0 ? 'userSearchResults' : 'projectUserSearchResults').innerHTML = '';
}

function updateSelectedUsers(type) {
    const targetArray = type === 0 ? selectedUsers : projectSelectedUsers;
    const targetContainer = type === 0 ? 'selectedUsers' : 'projectSelectedUsers';
    
    document.getElementById(targetContainer).innerHTML = targetArray.map(user => `
        <span class="badge bg-primary me-2 mb-2">
            ${user.username}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    onclick="removeSelectedUser(${type}, ${user.id})"></button>
        </span>
    `).join('');
}

function removeSelectedUser(type, userId) {
    const targetArray = type === 0 ? selectedUsers : projectSelectedUsers;
    const index = targetArray.findIndex(u => u.id === userId);
    if (index > -1) {
        targetArray.splice(index, 1);
        updateSelectedUsers(type);
    }
}

function inviteToTeam(teamId) {
    currentTeamId = teamId;
    // Reset previous selections
    selectedUsers = [];
    document.getElementById('selectedUsers').innerHTML = '';
    document.getElementById('userSearch').value = '';
    document.getElementById('userSearchResults').innerHTML = '';
    
    $('#inviteToTeamModal').modal('show');
}

function sendTeamInvitations() {
    if (selectedUsers.length === 0) {
        showToast('Please select at least one user', 'warning');
        return;
    }
    
    fetch(`/teams/${currentTeamId}/invite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            usernames: selectedUsers.map(u => u.username)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#inviteToTeamModal').modal('hide');
            showToast(data.message, 'success');
            selectedUsers = [];
            currentTeamId = null;
        } else {
            showToast(data.error, 'error');
        }
    });
}

// Team Settings Management
function updateTeamSettings(teamId) {
    const name = document.getElementById('teamName').value;
    const description = document.getElementById('teamDescription').value;
    const teamColor = document.getElementById('teamColor').value;
    
    if (!name.trim()) {
        showToast('Team name is required', 'error');
        return;
    }
    
    fetch(`/teams/${teamId}/settings`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            description: description,
            settings: {
                team_color: teamColor
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Team settings updated successfully', 'success');
            // Update the team color in the UI
            document.documentElement.style.setProperty('--team-color', teamColor);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while updating team settings', 'error');
    });
}

function updateTeamPermissions(teamId) {
    const allowMemberInvites = document.getElementById('allowMemberInvites').checked;
    const defaultProjectPrivacy = document.getElementById('defaultProjectPrivacy').value;
    const allowProjectDeletion = document.getElementById('allowProjectDeletion').checked;
    
    fetch(`/teams/${teamId}/settings`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            settings: {
                allow_member_invites: allowMemberInvites,
                default_project_privacy: defaultProjectPrivacy,
                allow_project_deletion: allowProjectDeletion
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Team permissions updated successfully', 'success');
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while updating permissions', 'error');
    });
}

// Member Role Management
function setupRoleChangeListeners() {
    document.querySelectorAll('.member-role').forEach(select => {
        select.addEventListener('change', function() {
            const memberId = this.getAttribute('data-member-id');
            const newRole = this.value;
            
            updateMemberRole({{ team.id }}, memberId, newRole);
        });
    });
}

function updateMemberRole(teamId, memberId, newRole) {
    fetch(`/teams/${teamId}/settings/members`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            role: newRole
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
        } else {
            showToast(data.error, 'error');
            // Revert the select to its previous value
            location.reload(); // Simple reload to reset
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while updating member role', 'error');
        location.reload();
    });
}

// Team Deletion
function deleteTeam(teamId) {
    if (!confirm('Are you sure you want to delete this team? This action cannot be undone and will remove all team associations from projects.')) {
        return;
    }
    
    if (!confirm('This will permanently delete the team and remove all members. Are you absolutely sure?')) {
        return;
    }
    
    fetch(`/teams/${teamId}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.href = "{{ url_for('teams.teams_dashboard') }}";
            }, 1500);
        } else {
            showToast(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while deleting the team', 'error');
    });
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupRoleChangeListeners();
    setupUserSearch();
    // Set team color variable
    const teamColor = '{{ team.team_color }}';
    document.documentElement.style.setProperty('--team-color', teamColor);
});
</script>

<style>
:root {
    --team-color: {{ team.team_color }};
}

.avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 14px;
    font-weight: bold;
}

.stat {
    padding: 10px 0;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.team-meta {
    font-size: 0.9rem;
}

.border-danger {
    border: 1px solid #dc3545 !important;
}

.form-control-color {
    height: 38px;
    padding: 2px;
}

.member-role {
    min-width: 100px;
}
</style>
{% endblock %}